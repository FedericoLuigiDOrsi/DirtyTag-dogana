<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß DEBUG ‚Äî Dogana Import</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f3460;
            --accent: #e94560;
            --success: #00d26a;
            --warning: #ffc107;
            --text: #eee;
            --text-muted: #888;
            --border: #333;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }
        
        h1 { margin-bottom: 1rem; }
        h2 { margin: 1.5rem 0 1rem; color: var(--accent); }
        h3 { margin: 1rem 0 0.5rem; color: var(--warning); }
        
        .card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        input, select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.8rem 1rem;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            margin: 0.5rem 0;
        }
        
        button {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        
        button:hover { opacity: 0.9; }
        button.secondary { background: var(--bg-input); border: 1px solid var(--border); }
        button.success { background: var(--success); color: #000; }
        
        .log {
            background: #000;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-entry { margin: 0.3rem 0; }
        .log-info { color: #4fc3f7; }
        .log-success { color: #81c784; }
        .log-error { color: #e57373; }
        .log-warn { color: #ffb74d; }
        .log-data { color: #ce93d8; }
        
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin: 0.2rem;
        }
        .status-ok { background: var(--success); color: #000; }
        .status-error { background: var(--accent); }
        .status-pending { background: var(--warning); color: #000; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th { color: var(--accent); }
        
        code {
            background: var(--bg-input);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .flex { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>
    <h1>üîß Debug Console ‚Äî Dogana Import v7</h1>
    
    <!-- Step 1: Token -->
    <div class="card">
        <h2>Step 1: Configurazione Token</h2>
        <div class="flex">
            <input type="password" id="tokenInput" placeholder="pat_xxxxxxxxxxxxx" style="flex: 1;">
            <button onclick="saveToken()">üíæ Salva Token</button>
            <button class="secondary" onclick="clearToken()">üóëÔ∏è Cancella</button>
        </div>
        <p style="margin-top: 0.5rem; color: var(--text-muted);">
            Token salvato: <span id="tokenStatus">-</span>
        </p>
    </div>
    
    <!-- Step 2: Base Selection -->
    <div class="card">
        <h2>Step 2: Configurazione Base Airtable</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Quale base vuoi usare?</p>
        
        <div class="flex">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="baseSelect" value="apptPbWnDkDkKEpFV" checked>
                <span>DirtyTag 2.0 <code>apptPbWnDkDkKEpFV</code></span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="baseSelect" value="apptD8GSxN3vhhivI">
                <span>DirtyTag 3.0 <code>apptD8GSxN3vhhivI</code></span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="baseSelect" value="custom">
                <span>Custom:</span>
            </label>
            <input type="text" id="customBaseId" placeholder="appXXXXXXXXX" style="width: 200px;">
        </div>
        
        <button onclick="testBaseConnection()" style="margin-top: 1rem;">üîå Test Connessione Base</button>
    </div>
    
    <!-- Step 3: Diagnostic Tests -->
    <div class="card">
        <h2>Step 3: Test Diagnostici</h2>
        <div class="flex">
            <button onclick="listTables()">üìã Lista Tabelle</button>
            <button onclick="testOldInventory()">üóÑÔ∏è Test OLD_INVENTORY</button>
            <button onclick="testPhotoCandidates()">üì∑ Test PHOTO_CANDIDATES</button>
            <button onclick="testAllFields()">üîç Analizza Campi</button>
            <button class="success" onclick="runFullDiagnostic()">üöÄ Diagnostica Completa</button>
        </div>
    </div>
    
    <!-- Step 4: Manual Query -->
    <div class="card">
        <h2>Step 4: Query Manuale</h2>
        <div class="grid">
            <div>
                <label>Table ID:</label>
                <input type="text" id="queryTableId" placeholder="tblXXXXXXXXX">
            </div>
            <div>
                <label>Filter Formula (opzionale):</label>
                <input type="text" id="queryFilter" placeholder="{Status}='Active'">
            </div>
        </div>
        <div class="flex" style="margin-top: 1rem;">
            <button onclick="runManualQuery()">‚ñ∂Ô∏è Esegui Query</button>
            <button class="secondary" onclick="runManualQuery(true)">üìä Solo Conteggio</button>
        </div>
    </div>
    
    <!-- Results Panel -->
    <div class="card">
        <h2>üìä Risultati</h2>
        <div id="resultsPanel">
            <p style="color: var(--text-muted);">Esegui un test per vedere i risultati...</p>
        </div>
    </div>
    
    <!-- Log Panel -->
    <div class="card">
        <div class="flex" style="justify-content: space-between;">
            <h2 style="margin: 0;">üìú Log Console</h2>
            <button class="secondary" onclick="clearLog()">üóëÔ∏è Pulisci Log</button>
        </div>
        <div class="log" id="logPanel"></div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let token = localStorage.getItem('airtable_token') || '';
        let baseId = 'apptPbWnDkDkKEpFV';
        
        // Known table IDs (from documentation)
        const KNOWN_TABLES = {
            'DirtyTag 2.0': {
                baseId: 'apptPbWnDkDkKEpFV',
                tables: {
                    'OLD_INVENTORY': null,  // Unknown - need to discover
                    'PHOTO_CANDIDATES': 'tbl7ogfLnHsVfFdzb'
                }
            },
            'DirtyTag 3.0': {
                baseId: 'apptD8GSxN3vhhivI',
                tables: {
                    'INVENTARIO': 'tblddAcLcQAyk050u',
                    'RAW': 'tblUWMOM3HKCCEwu6',
                    'CONTABILIT√Ä': 'tblaTinKaG2gUGypa'
                }
            }
        };
        
        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            updateTokenStatus();
            if (token) {
                document.getElementById('tokenInput').value = token;
            }
            log('info', 'üöÄ Debug console inizializzata');
            log('info', `üì¶ Token in localStorage: ${token ? 'S√å (' + token.substring(0,15) + '...)' : 'NO'}`);
        });
        
        // ============================================
        // TOKEN MANAGEMENT
        // ============================================
        function saveToken() {
            const input = document.getElementById('tokenInput').value.trim();
            if (!input) {
                log('error', '‚ùå Token vuoto');
                return;
            }
            if (!input.startsWith('pat')) {
                log('warn', '‚ö†Ô∏è Il token dovrebbe iniziare con "pat" - procedo comunque');
            }
            token = input;
            localStorage.setItem('airtable_token', token);
            updateTokenStatus();
            log('success', '‚úÖ Token salvato: ' + token.substring(0, 20) + '...');
        }
        
        function clearToken() {
            localStorage.removeItem('airtable_token');
            token = '';
            document.getElementById('tokenInput').value = '';
            updateTokenStatus();
            log('info', 'üóëÔ∏è Token cancellato');
        }
        
        function updateTokenStatus() {
            const el = document.getElementById('tokenStatus');
            if (token && token.length > 10) {
                el.innerHTML = `<span class="status-badge status-ok">‚úì ${token.substring(0,15)}...</span>`;
            } else {
                el.innerHTML = `<span class="status-badge status-error">‚úó Nessun token</span>`;
            }
        }
        
        function getSelectedBaseId() {
            const selected = document.querySelector('input[name="baseSelect"]:checked').value;
            if (selected === 'custom') {
                return document.getElementById('customBaseId').value.trim();
            }
            return selected;
        }
        
        // ============================================
        // API CALLS
        // ============================================
        async function apiCall(endpoint, options = {}) {
            if (!token) {
                throw new Error('Token non configurato');
            }
            
            const url = `https://api.airtable.com/v0/${endpoint}`;
            log('info', `üîó API: ${url}`);
            
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                log('error', `‚ùå HTTP ${response.status}: ${JSON.stringify(data)}`);
                throw new Error(`HTTP ${response.status}: ${data.error?.message || 'Unknown error'}`);
            }
            
            return data;
        }
        
        // ============================================
        // DIAGNOSTIC FUNCTIONS
        // ============================================
        async function testBaseConnection() {
            const base = getSelectedBaseId();
            log('info', `üîå Testing connessione a base: ${base}`);
            
            try {
                // Try to get base schema (requires meta API)
                const url = `https://api.airtable.com/v0/meta/bases/${base}/tables`;
                log('info', `üì° Fetching: ${url}`);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    log('error', '‚ùå 401 Unauthorized - Token non valido o scaduto');
                    showResult('error', 'Token non valido', 'Verifica che il token sia corretto e non scaduto');
                    return;
                }
                
                if (response.status === 403) {
                    log('warn', '‚ö†Ô∏è 403 Forbidden - Token non ha accesso alla Meta API');
                    log('info', 'üí° Provo con una query diretta alla base...');
                    
                    // Fallback: try a direct table query
                    await testDirectQuery(base);
                    return;
                }
                
                if (response.status === 404) {
                    log('error', `‚ùå 404 Not Found - Base ID "${base}" non esiste`);
                    showResult('error', 'Base non trovata', `Il Base ID "${base}" non esiste o il token non ha accesso`);
                    return;
                }
                
                const data = await response.json();
                log('success', `‚úÖ Connessione OK! Trovate ${data.tables?.length || 0} tabelle`);
                
                // Display tables
                displayTables(data.tables);
                
            } catch (error) {
                log('error', `‚ùå Errore: ${error.message}`);
                showResult('error', 'Errore connessione', error.message);
            }
        }
        
        async function testDirectQuery(base) {
            // Try common table names
            const testTables = ['OLD_INVENTORY', 'INVENTARIO', 'Inventory', 'Products'];
            
            for (const tableName of testTables) {
                try {
                    log('info', `üîç Provo tabella: ${tableName}`);
                    const url = `https://api.airtable.com/v0/${base}/${encodeURIComponent(tableName)}?maxRecords=1`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('success', `‚úÖ Tabella "${tableName}" trovata! ${data.records?.length || 0} record campione`);
                        
                        if (data.records?.length > 0) {
                            log('data', `üìã Campi disponibili: ${Object.keys(data.records[0].fields).join(', ')}`);
                        }
                        
                        showResult('success', 'Connessione OK', `Tabella "${tableName}" accessibile`);
                        return;
                    }
                } catch (e) {
                    // Continue to next table
                }
            }
            
            log('error', '‚ùå Nessuna tabella standard trovata');
            showResult('error', 'Nessuna tabella trovata', 'Verifica il Base ID e i permessi del token');
        }
        
        async function listTables() {
            const base = getSelectedBaseId();
            log('info', `üìã Listing tabelle per base: ${base}`);
            
            try {
                const url = `https://api.airtable.com/v0/meta/bases/${base}/tables`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        log('warn', '‚ö†Ô∏è Meta API non accessibile - il token potrebbe non avere scope schema.bases:read');
                        log('info', 'üí° Prova ad aggiungere lo scope "schema.bases:read" al token');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displayTables(data.tables);
                
            } catch (error) {
                log('error', `‚ùå Errore: ${error.message}`);
            }
        }
        
        function displayTables(tables) {
            if (!tables || tables.length === 0) {
                showResult('warn', 'Nessuna tabella', 'La base non contiene tabelle o non hai accesso');
                return;
            }
            
            let html = '<h3>Tabelle trovate:</h3><table><tr><th>Nome</th><th>ID</th><th>Campi</th></tr>';
            
            tables.forEach(t => {
                const fieldCount = t.fields?.length || '?';
                html += `<tr>
                    <td><strong>${t.name}</strong></td>
                    <td><code>${t.id}</code></td>
                    <td>${fieldCount} campi</td>
                </tr>`;
                
                log('data', `üìÅ ${t.name} (${t.id}) - ${fieldCount} campi`);
            });
            
            html += '</table>';
            
            // Add field details
            tables.forEach(t => {
                if (t.fields?.length > 0) {
                    html += `<h3>Campi di "${t.name}":</h3><table><tr><th>Nome</th><th>Tipo</th></tr>`;
                    t.fields.forEach(f => {
                        html += `<tr><td>${f.name}</td><td><code>${f.type}</code></td></tr>`;
                    });
                    html += '</table>';
                }
            });
            
            showResult('success', `${tables.length} tabelle trovate`, html, true);
        }
        
        async function testOldInventory() {
            const base = getSelectedBaseId();
            log('info', `üóÑÔ∏è Testing OLD_INVENTORY in base: ${base}`);
            
            // Try different possible table names/IDs
            const possibilities = [
                { name: 'OLD_INVENTORY', id: null },
                { name: 'INVENTARIO', id: 'tblddAcLcQAyk050u' },
                { name: 'Inventario', id: null },
                { name: 'Products', id: null }
            ];
            
            for (const p of possibilities) {
                const tableRef = p.id || encodeURIComponent(p.name);
                try {
                    log('info', `üîç Provo: ${p.name} (${tableRef})`);
                    
                    const url = `https://api.airtable.com/v0/${base}/${tableRef}?maxRecords=3`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('success', `‚úÖ "${p.name}" TROVATA!`);
                        log('data', `   Records: ${data.records?.length || 0}`);
                        
                        if (data.records?.length > 0) {
                            const fields = Object.keys(data.records[0].fields);
                            log('data', `   Campi: ${fields.join(', ')}`);
                            
                            // Check for expected fields
                            const expectedFields = ['SKU', 'Category', 'Brand', 'Photo_Audit_Status', 'Photo_Count'];
                            const found = expectedFields.filter(f => fields.includes(f));
                            const missing = expectedFields.filter(f => !fields.includes(f));
                            
                            log('info', `   ‚úì Campi trovati: ${found.join(', ')}`);
                            if (missing.length > 0) {
                                log('warn', `   ‚ö†Ô∏è Campi mancanti: ${missing.join(', ')}`);
                            }
                            
                            showResult('success', `Tabella "${p.name}" OK`, `
                                <p><strong>Table ID:</strong> <code>${p.id || p.name}</code></p>
                                <p><strong>Campi trovati (${found.length}/${expectedFields.length}):</strong> ${found.join(', ')}</p>
                                ${missing.length > 0 ? `<p style="color: var(--warning);">‚ö†Ô∏è Campi mancanti: ${missing.join(', ')}</p>` : ''}
                                <p><strong>Tutti i campi:</strong> ${fields.join(', ')}</p>
                            `, true);
                        }
                        return;
                    } else {
                        log('warn', `   ‚ùå ${response.status} per "${p.name}"`);
                    }
                } catch (e) {
                    log('warn', `   ‚ùå Errore: ${e.message}`);
                }
            }
            
            log('error', '‚ùå Nessuna tabella inventory trovata!');
            showResult('error', 'Tabella non trovata', 'Verifica il nome della tabella nella base Airtable');
        }
        
        async function testPhotoCandidates() {
            const base = getSelectedBaseId();
            const tableId = 'tbl7ogfLnHsVfFdzb';
            
            log('info', `üì∑ Testing PHOTO_CANDIDATES (${tableId}) in base: ${base}`);
            
            try {
                const url = `https://api.airtable.com/v0/${base}/${tableId}?maxRecords=3`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    log('error', `‚ùå ${response.status}: ${err.error?.message}`);
                    showResult('error', 'PHOTO_CANDIDATES non accessibile', err.error?.message);
                    return;
                }
                
                const data = await response.json();
                log('success', `‚úÖ PHOTO_CANDIDATES OK - ${data.records?.length || 0} record campione`);
                
                if (data.records?.length > 0) {
                    const fields = Object.keys(data.records[0].fields);
                    log('data', `   Campi: ${fields.join(', ')}`);
                    
                    showResult('success', 'PHOTO_CANDIDATES OK', `
                        <p><strong>Table ID:</strong> <code>${tableId}</code></p>
                        <p><strong>Campi:</strong> ${fields.join(', ')}</p>
                        <p><strong>Sample SKU:</strong> ${data.records[0].fields.SKU || 'N/A'}</p>
                    `, true);
                }
                
            } catch (error) {
                log('error', `‚ùå Errore: ${error.message}`);
            }
        }
        
        async function testAllFields() {
            const base = getSelectedBaseId();
            log('info', `üîç Analisi completa campi per base: ${base}`);
            
            await testOldInventory();
            await testPhotoCandidates();
        }
        
        async function runFullDiagnostic() {
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', 'üöÄ AVVIO DIAGNOSTICA COMPLETA');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            const results = {
                token: false,
                base: false,
                oldInventory: false,
                photoCandidates: false,
                requiredFields: []
            };
            
            // 1. Token check
            log('info', '\nüìã Step 1: Verifica Token');
            if (token && token.length > 10) {
                log('success', '‚úÖ Token presente');
                results.token = true;
            } else {
                log('error', '‚ùå Token mancante o troppo corto');
                showResult('error', 'Diagnostica fallita', 'Inserisci un token valido prima di procedere');
                return;
            }
            
            // 2. Base connection
            log('info', '\nüìã Step 2: Connessione Base');
            const base = getSelectedBaseId();
            try {
                await testBaseConnection();
                results.base = true;
            } catch (e) {
                log('error', `‚ùå Connessione fallita: ${e.message}`);
            }
            
            // 3. Table tests
            log('info', '\nüìã Step 3: Test Tabelle');
            
            // Test OLD_INVENTORY with different names
            const inventoryTests = ['OLD_INVENTORY', 'INVENTARIO', 'Inventario'];
            for (const tableName of inventoryTests) {
                try {
                    const url = `https://api.airtable.com/v0/${base}/${encodeURIComponent(tableName)}?maxRecords=1`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('success', `‚úÖ Tabella "${tableName}" trovata`);
                        results.oldInventory = { name: tableName, sample: data.records?.[0] };
                        
                        if (data.records?.[0]) {
                            results.requiredFields = Object.keys(data.records[0].fields);
                        }
                        break;
                    }
                } catch (e) { }
            }
            
            if (!results.oldInventory) {
                log('error', '‚ùå Nessuna tabella inventory trovata');
            }
            
            // 4. Summary
            log('info', '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('info', 'üìä RIEPILOGO DIAGNOSTICA');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log(results.token ? 'success' : 'error', `Token: ${results.token ? '‚úÖ' : '‚ùå'}`);
            log(results.base ? 'success' : 'error', `Connessione Base: ${results.base ? '‚úÖ' : '‚ùå'}`);
            log(results.oldInventory ? 'success' : 'error', `Inventory Table: ${results.oldInventory ? '‚úÖ ' + results.oldInventory.name : '‚ùå'}`);
            
            if (results.requiredFields.length > 0) {
                log('data', `\nCampi disponibili:\n${results.requiredFields.join('\n')}`);
            }
            
            // Build summary HTML
            let summaryHtml = '<table>';
            summaryHtml += `<tr><td>Token</td><td>${results.token ? '<span class="status-badge status-ok">‚úì OK</span>' : '<span class="status-badge status-error">‚úó Mancante</span>'}</td></tr>`;
            summaryHtml += `<tr><td>Base ID</td><td><code>${base}</code></td></tr>`;
            summaryHtml += `<tr><td>Inventory Table</td><td>${results.oldInventory ? '<span class="status-badge status-ok">‚úì ' + results.oldInventory.name + '</span>' : '<span class="status-badge status-error">‚úó Non trovata</span>'}</td></tr>`;
            summaryHtml += '</table>';
            
            if (results.requiredFields.length > 0) {
                summaryHtml += '<h3>Campi disponibili:</h3><ul>';
                results.requiredFields.forEach(f => {
                    const isRequired = ['SKU', 'Category', 'Brand', 'Photo_Audit_Status'].includes(f);
                    summaryHtml += `<li>${isRequired ? '‚≠ê ' : ''}${f}</li>`;
                });
                summaryHtml += '</ul>';
            }
            
            showResult(
                results.token && results.oldInventory ? 'success' : 'error',
                'Diagnostica Completata',
                summaryHtml,
                true
            );
        }
        
        async function runManualQuery() {
            const base = getSelectedBaseId();
            const tableId = document.getElementById('queryTableId').value.trim();
            const filter = document.getElementById('queryFilter').value.trim();
            
            if (!tableId) {
                log('error', '‚ùå Inserisci un Table ID');
                return;
            }
            
            log('info', `üîç Query manuale: ${base}/${tableId}`);
            if (filter) log('info', `   Filter: ${filter}`);
            
            try {
                let url = `https://api.airtable.com/v0/${base}/${tableId}?maxRecords=10`;
                if (filter) {
                    url += `&filterByFormula=${encodeURIComponent(filter)}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    log('error', `‚ùå ${response.status}: ${data.error?.message}`);
                    showResult('error', 'Query fallita', data.error?.message);
                    return;
                }
                
                log('success', `‚úÖ Query OK - ${data.records?.length || 0} record`);
                
                let html = `<p><strong>Records:</strong> ${data.records?.length || 0}</p>`;
                
                if (data.records?.length > 0) {
                    const fields = Object.keys(data.records[0].fields);
                    html += `<p><strong>Campi:</strong> ${fields.join(', ')}</p>`;
                    html += '<h3>Sample Data:</h3><pre style="background: #000; padding: 1rem; overflow-x: auto;">' + 
                            JSON.stringify(data.records.slice(0, 3), null, 2) + '</pre>';
                }
                
                showResult('success', 'Query completata', html, true);
                
            } catch (error) {
                log('error', `‚ùå Errore: ${error.message}`);
            }
        }
        
        // ============================================
        // UI HELPERS
        // ============================================
        function log(type, message) {
            const panel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logPanel').innerHTML = '';
            log('info', 'üóëÔ∏è Log pulito');
        }
        
        function showResult(type, title, content, isHtml = false) {
            const panel = document.getElementById('resultsPanel');
            const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--accent)' : 'var(--warning)';
            
            panel.innerHTML = `
                <div style="border-left: 4px solid ${color}; padding-left: 1rem;">
                    <h3 style="color: ${color}; margin-top: 0;">${title}</h3>
                    ${isHtml ? content : `<p>${content}</p>`}
                </div>
            `;
        }
    </script>
</body>
</html>
